name: Publish Extension

on:
    workflow_run:
        workflows: ["Build and Release Extension"]
        types:
            - completed

jobs:
    publish:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        name: Publish webextension
        runs-on: ubuntu-latest

        permissions:
            contents: read

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download release asset
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  tag_name=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name')
                  echo "Latest tag: $tag_name"
                  gh release download "$tag_name" \
                    --repo ${{ github.repository }} \
                    --pattern "kmitl-x-${tag_name}.zip" \
                    --dir .

            - name: Publish to Chrome Web Store
              uses: mnao305/chrome-extension-upload@v5.0.0
              with:
                  file-path: ./kmitl-x-${{ github.ref_name || github.event.workflow_run.head_branch }}.zip
                  extension-id: ${{ secrets.EXTENSION_ID }}
                  client-id: ${{ secrets.CLIENT_ID }}
                  client-secret: ${{ secrets.CLIENT_SECRET }}
                  refresh-token: ${{ secrets.REFRESH_TOKEN }}
                  publish: true
